<!--
 Licensed Materials - Property of IBM
 IBM Order Management Software (5725-D10)
 (C) Copyright IBM Corp. 2018, 2019 All Rights Reserved.
 US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp. 
-->

{{- $varSslEnabled := .Values.appserver.ingress.ssl.enabled }}
{{- $trustStoreRef := "" }}
{{- if .Values.global.security }}
{{- if .Values.global.security.ssl }}
{{- if .Values.global.security.ssl.trustStore }}

{{- if and (.Values.global.security.ssl.trustStore.storeLocation) (ne .Values.global.security.ssl.trustStore.storeLocation "") }}
{{- $trustStoreRef = (printf "%s=%s" "trustStoreRef" "\"defaultTrustStore\"") }}
{{- end }}

{{- if.Values.global.security.ssl.trustStore.trustJavaCACerts }}
{{- $trustStoreRef = (printf "%s=%s" "trustStoreRef" "\"defaultTrustStore\"") }}
{{- end }}

{{- if and (.Values.global.security.ssl.trustStore.trustedCertDir) (ne .Values.global.security.ssl.trustStore.trustedCertDir "") }}
{{- $trustStoreRef = (printf "%s=%s" "trustStoreRef" "\"defaultTrustStore\"") }}
{{- end }}

{{- end }}
{{- end }}
{{- end }}

<server description="Default server">

        <!-- Enable features -->
        <featureManager>
                <feature>adminCenter-1.0</feature>
                <feature>jdbc-4.1</feature>
                <feature>jndi-1.0</feature>
                <feature>jsp-2.3</feature>
                <feature>servlet-3.1</feature>
                <feature>ssl-1.0</feature>
                <feature>monitor-1.0</feature>
                <feature>localConnector-1.0</feature>
        </featureManager>

       <!-- Define an Administrator and non-Administrator -->
        <basicRegistry id="basic">
                <user name="admin" password="${env.consoleadminpassword}" />
                <user name="nonadmin" password="${env.consolenonadminpassword}" />
        </basicRegistry>

        <!-- Assign 'admin' to Administrator -->
        <administrator-role>
                <user>admin</user>
        </administrator-role>

        <!-- {{ $trustStoreRef }} -->

        <ssl id="defaultSSLSettings" sslProtocol="TLSv1.2" keyStoreRef="defaultKeyStore" trustStoreRef="defaultTrustStore" clientAuthenticationSupported="true" />
		<keyStore id="defaultKeyStore" location="${server.config.dir}/tls.p12" type="PKCS12" password="${env.tlskeystorepassword}" />
	<!-- {{- if ne $trustStoreRef "" }} -->	
		<keyStore id="defaultTrustStore" location="${env.JAVA_TRUST_STORE_PATH}" type="PKCS12" password="${env.JAVA_TRUST_STORE_PASS}" />
		{{- end }}

        <httpEndpoint id="defaultHttpEndpoint" host="*" httpPort="{{ .Values.appserver.service.http.port | default 9080 }}"
                httpsPort="{{ .Values.appserver.service.https.port | default 9443 }}" />

        <executor name="Default Executor" coreThreads="{{ .Values.appserver.config.corethreads }}" maxThreads="{{ .Values.appserver.config.maxthreads }}"/>

				
        <dataSource id="DefaultDataSource" jndiName="{{ .Values.global.database.datasourceName }}">
                <jdbcDriver libraryRef="dblib" />
                <connectionManager maxPoolSize="{{ .Values.appserver.config.database.maxPoolSize }}" minPoolSize="{{ .Values.appserver.config.database.minPoolSize }}" />
                {{- if eq (.Values.global.database.dbvendor | lower) "oracle" }}
                <properties.oracle databaseName="{{ .Values.global.database.dbname }}" serverName="{{ .Values.global.database.serverName }}"
                        portNumber="{{ .Values.global.database.port }}" user="{{ .Values.global.database.user }}" password="${env.dbpassword}" />
                {{- else }}
                <properties.db2.jcc databaseName="{{ .Values.global.database.dbname }}" serverName="{{ .Values.global.database.serverName }}"
                        portNumber="{{ .Values.global.database.port }}" user="{{ .Values.global.database.user }}" password="${env.dbpassword}" 
                        currentSchema="{{ .Values.global.database.schema | default (.Values.global.database.dbname | default "" | upper) }}" sslConnection="{{ .Values.global.database.ssl }}" />
                {{- end }}
        </dataSource>

        <library id="dblib">
                <fileset dir="/opt/ibm/jars/" includes="*.jar" />
        </library>
	
        <httpSession useContextRootAsCookiePath="true" {{- if $varSslEnabled }} cookieSecure="true" {{- end }} />

        <!-- Automatically expand WAR files and EAR files -->
        <applicationManager autoExpand="true" />
</server>
